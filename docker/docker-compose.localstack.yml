version: '3.8'

# LocalStack Development Environment
# Complete local AWS cloud architecture
# Replaces: S3, DynamoDB, Lambda, API Gateway, CloudFront (simulated), SES

services:
  localstack:
    container_name: galerly-localstack
    image: localstack/localstack:latest
    ports:
      # LocalStack edge port - single entry point for all services
      - "${LOCALSTACK_PORT:-4566}:4566"
      # External services port (optional)
      - "${LOCALSTACK_EXTERNAL_PORT_START:-4510}-${LOCALSTACK_EXTERNAL_PORT_END:-4559}:4510-4559"
      # Web UI dashboard (pro feature, optional)
      - "${LOCALSTACK_UI_PORT:-8080}:8080"
    environment:
      # Core LocalStack configuration
      - SERVICES=${LOCALSTACK_SERVICES:-s3,dynamodb,lambda,apigateway,ses,sts,iam,cloudformation,events,cloudwatch,logs}
      - DEBUG=${LOCALSTACK_DEBUG:-1}
      - PERSISTENCE=${LOCALSTACK_PERSISTENCE:-1}
      - LAMBDA_EXECUTOR=${LOCALSTACK_LAMBDA_EXECUTOR:-docker-reuse}
      - LAMBDA_RUNTIME_ENVIRONMENT_TIMEOUT=${LOCALSTACK_LAMBDA_TIMEOUT:-300}
      - LAMBDA_REMOVE_CONTAINERS=${LOCALSTACK_LAMBDA_REMOVE_CONTAINERS:-true}
      - DOCKER_HOST=unix:///var/run/docker.sock
      
      # AWS configuration from .env.local
      - AWS_DEFAULT_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      
      # LocalStack-specific settings
      - EDGE_PORT=${LOCALSTACK_PORT:-4566}
      - HOSTNAME=${LOCALSTACK_HOSTNAME:-localhost}
      - HOSTNAME_EXTERNAL=${LOCALSTACK_HOSTNAME_EXTERNAL:-localhost}
      
      # S3 configuration
      - S3_SKIP_SIGNATURE_VALIDATION=${S3_SKIP_SIGNATURE_VALIDATION:-1}
      
      # S3 bucket names for init scripts
      - S3_PHOTOS_BUCKET=${S3_PHOTOS_BUCKET}
      - S3_BUCKET=${S3_BUCKET}
      - S3_RENDITIONS_BUCKET=${S3_RENDITIONS_BUCKET}
      - AWS_ENDPOINT_URL=${AWS_ENDPOINT_URL}
      - AWS_REGION=${AWS_REGION}
      - FRONTEND_URL=${FRONTEND_URL}
      
      # Data persistence directory
      - DATA_DIR=/var/lib/localstack/data
      
    volumes:
      # Persist LocalStack data between restarts
      - "${LOCALSTACK_DATA_DIR:-../localstack_data}:/var/lib/localstack"
      # Mount docker socket for Lambda execution
      - "/var/run/docker.sock:/var/run/docker.sock"
      # Mount initialization scripts
      - "../local/init-scripts:/etc/localstack/init/ready.d"
      # Mount .env.local for init scripts
      - "../backend/.env.local:/etc/localstack/init/.env.local:ro"
    networks:
      - galerly-local

  # Optional: LocalStack Web UI for monitoring (requires LocalStack Pro)
  # Uncomment if you have a LocalStack Pro license
  # localstack-ui:
  #   container_name: galerly-localstack-ui
  #   image: localstack/localstack-pro
  #   ports:
  #     - "8081:8080"
  #   environment:
  #     - LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY}
  #   depends_on:
  #     - localstack
  #   networks:
  #     - galerly-local

  # Python backend API (running in Docker, connecting to LocalStack)
  backend:
    container_name: ${BACKEND_CONTAINER_NAME:-galerly-backend-local}
    build:
      context: ../backend
      dockerfile: Dockerfile.local
    ports:
      - "${BACKEND_PORT:-5001}:5001"
    env_file:
      - ../backend/.env.local
    environment:
      # Override for container networking (use container name for LocalStack)
      - AWS_ENDPOINT_URL=http://localstack:${LOCALSTACK_PORT:-4566}
    volumes:
      - ../backend:/app
    depends_on:
      - localstack
    networks:
      - galerly-local
    restart: unless-stopped

  # React frontend with Vite dev server
  frontend_react:
    container_name: ${FRONTEND_CONTAINER_NAME:-galerly-frontend-react-local}
    build:
      context: ../frontend react
      dockerfile: Dockerfile.local
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    environment:
      - VITE_ENVIRONMENT=local
      - VITE_IS_LOCALSTACK=true
      - VITE_BACKEND_HOST=localhost
      - VITE_BACKEND_PORT=5001
      - VITE_BACKEND_PROTOCOL=http
      - VITE_LOCALSTACK_HOST=localhost
      - VITE_LOCALSTACK_PORT=4566
      - VITE_S3_RENDITIONS_BUCKET=galerly-renditions-local
      - VITE_CHUNK_SIZE=5242880
      - VITE_MAX_CONCURRENT_UPLOADS=3
      - VITE_DEFAULT_PAGE_SIZE=20
      - VITE_MAX_PAGE_SIZE=100
      - VITE_API_TIMEOUT=30000
      - VITE_UPLOAD_TIMEOUT=300000
      - VITE_ENABLE_ANALYTICS=false
      - VITE_ENABLE_ERROR_REPORTING=false
    volumes:
      - ../frontend react:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - galerly-local
    restart: unless-stopped

networks:
  galerly-local:
    driver: bridge

volumes:
  localstack_data:
    driver: local

