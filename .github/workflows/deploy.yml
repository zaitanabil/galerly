name: ðŸš€ Galerly CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ========================================
  # STAGE 1: VALIDATION & PREREQUISITES
  # ========================================
  validate-secrets:
    name: ðŸ” Validate Secrets & Configuration
    runs-on: ubuntu-latest
    outputs:
      secrets-valid: ${{ steps.check-secrets.outputs.valid }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Required Secrets
        id: check-secrets
        run: |
          echo "ðŸ” Checking required secrets..."
          
          MISSING_SECRETS=""
          
          # AWS Credentials
          [[ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}AWS_ACCESS_KEY_ID "
          [[ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}AWS_SECRET_ACCESS_KEY "
          
          # Frontend
          [[ -z "${{ secrets.S3_BUCKET }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}S3_BUCKET "
          [[ -z "${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}CLOUDFRONT_DISTRIBUTION_ID "
          [[ -z "${{ secrets.FRONTEND_URL }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}FRONTEND_URL "
          
          # Backend
          [[ -z "${{ secrets.LAMBDA_FUNCTION_NAME }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}LAMBDA_FUNCTION_NAME "
          
          # DynamoDB
          [[ -z "${{ secrets.DYNAMODB_TABLE_USERS }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}DYNAMODB_TABLE_USERS "
          [[ -z "${{ secrets.DYNAMODB_TABLE_GALLERIES }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}DYNAMODB_TABLE_GALLERIES "
          [[ -z "${{ secrets.DYNAMODB_TABLE_PHOTOS }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}DYNAMODB_TABLE_PHOTOS "
          [[ -z "${{ secrets.DYNAMODB_TABLE_SESSIONS }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}DYNAMODB_TABLE_SESSIONS "
          [[ -z "${{ secrets.DYNAMODB_TABLE_SUBSCRIPTIONS }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}DYNAMODB_TABLE_SUBSCRIPTIONS "
          [[ -z "${{ secrets.DYNAMODB_TABLE_BILLING }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}DYNAMODB_TABLE_BILLING "
          
          # S3 Storage
          [[ -z "${{ secrets.S3_PHOTOS_BUCKET }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}S3_PHOTOS_BUCKET "
          
          # Stripe
          [[ -z "${{ secrets.STRIPE_SECRET_KEY }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}STRIPE_SECRET_KEY "
          [[ -z "${{ secrets.STRIPE_WEBHOOK_SECRET }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}STRIPE_WEBHOOK_SECRET "
          [[ -z "${{ secrets.STRIPE_PRICE_PLUS }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}STRIPE_PRICE_PLUS "
          [[ -z "${{ secrets.STRIPE_PRICE_PRO }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}STRIPE_PRICE_PRO "
          
          # Email
          [[ -z "${{ secrets.SMTP_HOST }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}SMTP_HOST "
          [[ -z "${{ secrets.SMTP_PORT }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}SMTP_PORT "
          [[ -z "${{ secrets.SMTP_USER }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}SMTP_USER "
          [[ -z "${{ secrets.SMTP_PASSWORD }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}SMTP_PASSWORD "
          [[ -z "${{ secrets.FROM_EMAIL }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}FROM_EMAIL "
          
          # CloudFront CDN
          [[ -z "${{ secrets.CDN_DOMAIN }}" ]] && MISSING_SECRETS="${MISSING_SECRETS}CDN_DOMAIN "
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ Missing required secrets: $MISSING_SECRETS"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… All required secrets are present"
            echo "valid=true" >> $GITHUB_OUTPUT
          fi

  # ========================================
  # STAGE 2: CODE QUALITY & LINTING
  # ========================================
  lint-and-validate:
    name: ðŸ” Code Quality & Validation
    runs-on: ubuntu-latest
    needs: validate-secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."
          cd backend
          pip install -r requirements.txt
          pip install pylint flake8 pytest
          echo "âœ… Dependencies installed"

      - name: Lint Python code
        run: |
          echo "ðŸ” Linting Python code..."
          cd backend
          
          # Run flake8 ONLY on application code (exclude dependencies)
          # Ignore: layer-package/, package/, python/, venv/, node_modules/
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --exclude=layer-package,package,python,venv,node_modules,__pycache__,.git
          
          flake8 . \
            --count \
            --exit-zero \
            --max-line-length=120 \
            --statistics \
            --exclude=layer-package,package,python,venv,node_modules,__pycache__,.git
          
          echo "âœ… Python linting complete"

      - name: Validate Python syntax
        run: |
          echo "ðŸ” Validating Python syntax..."
          cd backend
          python -m py_compile api.py
          python -m py_compile handlers/*.py
          python -m py_compile utils/*.py
          echo "âœ… Python syntax valid"

      - name: Check imports
        env: ${{ secrets }}
        run: |
          echo "ðŸ” Checking Python imports..."
          cd backend
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          # Test critical imports
          try:
              from handlers import auth_handler, gallery_handler, photo_handler
              from utils import auth, email, response, security
              print('âœ… All critical imports successful')
          except ImportError as e:
              print(f'âŒ Import failed: {e}')
              sys.exit(1)
          "

      - name: Validate frontend structure
        run: |
          echo "ðŸ” Validating frontend structure..."
          
          # Check required HTML files
          REQUIRED_HTML="index.html auth.html dashboard.html gallery.html client-gallery.html"
          for file in $REQUIRED_HTML; do
            if [ ! -f "frontend/$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          
          # Check required JS files
          REQUIRED_JS="config.js auth.js gallery.js"
          for file in $REQUIRED_JS; do
            if [ ! -f "frontend/js/$file" ]; then
              echo "âŒ Missing required file: js/$file"
              exit 1
            fi
          done
          
          # Check required CSS files
          if [ ! -f "frontend/css/style.css" ]; then
            echo "âŒ Missing required file: css/style.css"
            exit 1
          fi
          
          echo "âœ… Frontend structure valid"

  # ========================================
  # STAGE 3: AWS INFRASTRUCTURE SETUP & TESTS
  # ========================================
  setup-aws-infrastructure:
    name: âš™ï¸  Setup AWS Infrastructure
    runs-on: ubuntu-latest
    needs: [validate-secrets, lint-and-validate]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Python dependencies
        run: |
          cd backend
          pip install boto3

      - name: Create DynamoDB Tables if Missing
        run: |
          echo "ðŸ—„ï¸  Checking and creating DynamoDB tables..."
          cd backend
          python setup_dynamodb.py create
          echo "âœ… DynamoDB setup complete"

      - name: Configure S3 Buckets if Missing
        run: |
          echo "ðŸª£ Checking S3 buckets..."
          
          # Check and create frontend bucket
          if ! aws s3 ls s3://${{ secrets.S3_BUCKET }} >/dev/null 2>&1; then
            echo "ðŸ“¦ Creating frontend S3 bucket: ${{ secrets.S3_BUCKET }}"
            aws s3 mb s3://${{ secrets.S3_BUCKET }} --region ${{ env.AWS_REGION }}
            
            # Configure as static website
            aws s3 website s3://${{ secrets.S3_BUCKET }} \
              --index-document index.html \
              --error-document 404.html
            
            # Set public read policy for static website
            cat > /tmp/bucket-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [{
              "Sid": "PublicReadGetObject",
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::${{ secrets.S3_BUCKET }}/*"
            }]
          }
          EOF
            aws s3api put-bucket-policy \
              --bucket ${{ secrets.S3_BUCKET }} \
              --policy file:///tmp/bucket-policy.json
            
            echo "âœ… Frontend bucket created and configured"
          else
            echo "âœ… Frontend bucket exists: ${{ secrets.S3_BUCKET }}"
          fi
          
          # Check and create photos bucket
          if ! aws s3 ls s3://${{ secrets.S3_PHOTOS_BUCKET }} >/dev/null 2>&1; then
            echo "ðŸ“¦ Creating photos S3 bucket: ${{ secrets.S3_PHOTOS_BUCKET }}"
            aws s3 mb s3://${{ secrets.S3_PHOTOS_BUCKET }} --region ${{ env.AWS_REGION }}
            
            # Block public access (photos are private by default)
            aws s3api put-public-access-block \
              --bucket ${{ secrets.S3_PHOTOS_BUCKET }} \
              --public-access-block-configuration \
                "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=false,RestrictPublicBuckets=false"
            
            echo "âœ… Photos bucket created"
          else
            echo "âœ… Photos bucket exists: ${{ secrets.S3_PHOTOS_BUCKET }}"
          fi
          
          # Configure CORS for photos bucket
          cat > /tmp/photos-cors.json << EOF
          {
            "CORSRules": [{
              "AllowedOrigins": ["${{ secrets.FRONTEND_URL }}", "http://localhost:3000"],
              "AllowedMethods": ["GET", "HEAD", "POST", "PUT"],
              "AllowedHeaders": ["*"],
              "ExposeHeaders": ["ETag", "Content-Length", "Content-Type"],
              "MaxAgeSeconds": 3600
            }]
          }
          EOF
          aws s3api put-bucket-cors \
            --bucket ${{ secrets.S3_PHOTOS_BUCKET }} \
            --cors-configuration file:///tmp/photos-cors.json
          
          echo "âœ… S3 buckets ready"

  test-aws-infrastructure:
    name: â˜ï¸  Test AWS Infrastructure
    runs-on: ubuntu-latest
    needs: [setup-aws-infrastructure]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Test S3 Buckets
        run: |
          echo "ðŸª£ Testing S3 buckets..."
          
          # Test frontend bucket
          if aws s3 ls s3://${{ secrets.S3_BUCKET }} >/dev/null 2>&1; then
            echo "âœ… Frontend S3 bucket accessible: ${{ secrets.S3_BUCKET }}"
          else
            echo "âŒ Frontend S3 bucket not accessible: ${{ secrets.S3_BUCKET }}"
            exit 1
          fi
          
          # Test photos bucket
          if aws s3 ls s3://${{ secrets.S3_PHOTOS_BUCKET }} >/dev/null 2>&1; then
            echo "âœ… Photos S3 bucket accessible: ${{ secrets.S3_PHOTOS_BUCKET }}"
          else
            echo "âŒ Photos S3 bucket not accessible: ${{ secrets.S3_PHOTOS_BUCKET }}"
            exit 1
          fi

      - name: Test DynamoDB Tables
        run: |
          echo "ðŸ“Š Testing DynamoDB tables..."
          
          TABLES=(
            "${{ secrets.DYNAMODB_TABLE_USERS }}"
            "${{ secrets.DYNAMODB_TABLE_GALLERIES }}"
            "${{ secrets.DYNAMODB_TABLE_PHOTOS }}"
            "${{ secrets.DYNAMODB_TABLE_SESSIONS }}"
            "${{ secrets.DYNAMODB_TABLE_SUBSCRIPTIONS }}"
            "${{ secrets.DYNAMODB_TABLE_BILLING }}"
            "${{ secrets.DYNAMODB_TABLE_REFUNDS }}"
            "${{ secrets.DYNAMODB_TABLE_AUDIT_LOG }}"
          )
          
          for table in "${TABLES[@]}"; do
            if aws dynamodb describe-table --table-name "$table" >/dev/null 2>&1; then
              echo "âœ… Table exists: $table"
            else
              echo "âŒ Table not found: $table"
              exit 1
            fi
          done

      - name: Test Lambda Function
        run: |
          echo "âš¡ Testing Lambda function..."
          
          # Check if function exists
          if aws lambda get-function --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} >/dev/null 2>&1; then
            echo "âœ… Lambda function exists: ${{ secrets.LAMBDA_FUNCTION_NAME }}"
            
            # Get function details
            RUNTIME=$(aws lambda get-function-configuration --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} --query 'Runtime' --output text)
            MEMORY=$(aws lambda get-function-configuration --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} --query 'MemorySize' --output text)
            TIMEOUT=$(aws lambda get-function-configuration --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} --query 'Timeout' --output text)
            
            echo "  Runtime: $RUNTIME"
            echo "  Memory: ${MEMORY}MB"
            echo "  Timeout: ${TIMEOUT}s"
          else
            echo "âŒ Lambda function not found: ${{ secrets.LAMBDA_FUNCTION_NAME }}"
            exit 1
          fi

      - name: Test CloudFront Distribution
        run: |
          echo "ðŸŒ Testing CloudFront distribution..."
          
          if aws cloudfront get-distribution --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} >/dev/null 2>&1; then
            echo "âœ… CloudFront distribution exists: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
            
            STATUS=$(aws cloudfront get-distribution --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --query 'Distribution.Status' --output text)
            echo "  Status: $STATUS"
            
            if [ "$STATUS" != "Deployed" ]; then
              echo "âš ï¸  Warning: Distribution status is $STATUS (expected: Deployed)"
            fi
          else
            echo "âŒ CloudFront distribution not found: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
            exit 1
          fi

  # ========================================
  # STAGE 4: COMPREHENSIVE TEST SUITE
  # ========================================
  test-backend:
    name: ðŸ§ª Comprehensive Test Suite
    runs-on: ubuntu-latest
    needs: [setup-aws-infrastructure]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing test dependencies..."
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock moto requests
          echo "âœ… Dependencies installed"

      - name: Run Unit Tests
        env: ${{ secrets }}
        run: |
          echo "=========================================="
          echo "ðŸ§ª RUNNING UNIT TESTS"
          echo "=========================================="
          cd backend
          
          # Run unit tests (exclude integration tests)
          pytest tests/ -v -m "not integration and not slow" \
            --cov=handlers --cov=utils --cov=api \
            --cov-report=term-missing \
            --cov-report=html \
            --junitxml=test-results/junit.xml
          
          echo ""
          echo "âœ… Unit tests passed"

      - name: Run CDN Tests
        env: ${{ secrets }}
        run: |
          echo "=========================================="
          echo "ðŸŒ TESTING CDN & IMAGE URLS"
          echo "=========================================="
          cd backend
          
          # Run CDN-specific tests
          pytest tests/test_cdn.py -v
          
          echo ""
          echo "âœ… CDN tests passed"

      - name: Run Image Transformation Tests
        env: ${{ secrets }}
        run: |
          echo "=========================================="
          echo "ðŸ–¼ï¸  TESTING IMAGE TRANSFORMATION"
          echo "=========================================="
          cd backend
          
          # Run image transformation tests
          pytest tests/test_image_transformation.py -v
          
          echo ""
          echo "âœ… Image transformation tests passed"

      - name: Run Endpoint Tests
        env: ${{ secrets }}
        run: |
          echo "=========================================="
          echo "ðŸ“¡ TESTING API ENDPOINTS"
          echo "=========================================="
          cd backend
          
          # Run endpoint tests
          pytest tests/test_endpoints.py -v
          
          echo ""
          echo "âœ… Endpoint tests passed"

      - name: Run Frontend Validation Tests
        run: |
          echo "=========================================="
          echo "ðŸŽ¨ VALIDATING FRONTEND FILES"
          echo "=========================================="
          cd backend
          
          # Run frontend validation tests
          pytest tests/test_frontend.py -v
          
          echo ""
          echo "âœ… Frontend validation passed"

      - name: Test Lambda Handler Imports
        env: ${{ secrets }}
        run: |
          echo "=========================================="
          echo "ðŸ” TESTING HANDLER IMPORTS"
          echo "=========================================="
          cd backend
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          handlers_to_test = [
              'auth_handler',
              'gallery_handler',
              'photo_handler',
              'billing_handler',
              'dashboard_handler',
              'notification_handler',
              'social_handler',
              'visitor_tracking_handler',
              'client_handler',
              'photo_upload_presigned',
              'subscription_handler'
          ]
          
          failed = []
          for handler in handlers_to_test:
              try:
                  exec(f'from handlers import {handler}')
                  print(f'âœ… {handler} imported successfully')
              except Exception as e:
                  print(f'âŒ {handler} import failed: {e}')
                  failed.append(handler)
          
          if failed:
              print(f'\\nâŒ Failed handlers: {failed}')
              sys.exit(1)
          else:
              print('\\nâœ… All handlers imported successfully')
          "
          echo ""

      - name: Run Integration Tests (Optional)
        env: ${{ secrets }}
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "ðŸ”— RUNNING INTEGRATION TESTS"
          echo "=========================================="
          echo "âš ï¸  Integration tests run against live AWS resources"
          echo "   Tests marked as 'integration' will be executed"
          echo ""
          cd backend
          
          # Run integration tests (against live AWS)
          pytest tests/ -v -m "integration" || echo "âš ï¸  Some integration tests failed (non-blocking)"
          
          echo ""
          echo "âœ… Integration tests completed"

      - name: Generate Test Report
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ“Š TEST SUMMARY"
          echo "=========================================="
          cd backend
          
          # Count test files
          TOTAL_TEST_FILES=$(find tests/ -name "test_*.py" | wc -l)
          echo "ðŸ“ Test Files: $TOTAL_TEST_FILES"
          echo ""
          
          # List all test files
          echo "ðŸ“‹ Test Files:"
          find tests/ -name "test_*.py" | sort | sed 's/tests\//   âœ… /'
          
          echo ""
          echo "=========================================="
          echo "âœ… ALL TESTS COMPLETE!"
          echo "=========================================="

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: backend/test-results/
          retention-days: 30

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/htmlcov/
          retention-days: 30

  # ========================================
  # STAGE 5: DEPLOY FRONTEND
  # ========================================
  deploy-frontend:
    name: ðŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    needs: [test-aws-infrastructure, test-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3
        run: |
          echo "ðŸš€ Deploying frontend to S3..."
          
          # Sync frontend files to S3 (deletes old files not in local)
          aws s3 sync frontend/ s3://${{ secrets.S3_BUCKET }}/ \
            --delete \
            --exclude ".git/*" \
            --exclude ".DS_Store" \
            --exclude "*.md" \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE
          
          # Set proper cache control for HTML files (no cache)
          aws s3 cp frontend/ s3://${{ secrets.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --metadata-directive REPLACE
          
          echo "âœ… Frontend deployed to S3"

      - name: Update CloudFront Function
        run: |
          echo "ðŸ”§ Updating CloudFront URL rewrite function..."
          
          FUNCTION_NAME="galerly-url-rewrite"
          
          if aws cloudfront describe-function --name $FUNCTION_NAME 2>/dev/null; then
            ETAG=$(aws cloudfront describe-function --name $FUNCTION_NAME --query 'ETag' --output text)
            
            aws cloudfront update-function \
              --name $FUNCTION_NAME \
              --function-code fileb://cloudfront/url-rewrite-function.js \
              --function-config Comment="URL rewrite for Galerly static site",Runtime="cloudfront-js-2.0" \
              --if-match $ETAG
            
            NEW_ETAG=$(aws cloudfront describe-function --name $FUNCTION_NAME --query 'ETag' --output text)
            aws cloudfront publish-function \
              --name $FUNCTION_NAME \
              --if-match $NEW_ETAG
            
            echo "âœ… CloudFront function updated"
          else
            echo "âš ï¸  CloudFront function not found, skipping"
          fi

      - name: Invalidate CloudFront Cache
        run: |
          echo "ðŸ”„ Invalidating CloudFront cache..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "âœ… Cache invalidation created: $INVALIDATION_ID"

  # ========================================
  # STAGE 6: DEPLOY BACKEND
  # ========================================
  deploy-backend:
    name: âš¡ Deploy Backend
    runs-on: ubuntu-latest
    needs: [test-aws-infrastructure, test-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Lambda Function using deploy-lambda.sh
        run: |
          echo "=========================================="
          echo "ðŸš€ DEPLOYING LAMBDA FUNCTION"
          echo "=========================================="
          echo ""
          echo "Using deploy-lambda.sh for consistent deployment..."
          echo ""
          
          cd backend
          
          # Set up Python virtual environment (required by deploy-lambda.sh)
          echo "ðŸ“¦ Setting up Python virtual environment..."
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          echo "âœ… Virtual environment created"
          echo ""
          
          # Install dependencies (required before deploy-lambda.sh runs)
          echo "ðŸ“š Installing dependencies from requirements.txt..."
          pip install -r requirements.txt --upgrade
          echo "âœ… Dependencies installed"
          echo ""
          
          # Make script executable
          chmod +x deploy-lambda.sh
          
          # Run the deployment script
          ./deploy-lambda.sh
          
          echo ""
          echo "=========================================="
          echo "âœ… Lambda Deployment Complete!"
          echo "=========================================="

      - name: Sync GitHub Secrets to Lambda Environment Variables
        env:
          SECRETS_JSON: ${{ toJson(secrets) }}
        run: |
          echo "ðŸ”„ SYNCING GitHub Secrets to Lambda Environment Variables..."
          echo ""
          
          # STEP 1: Get current Lambda environment variables
          echo "ðŸ“‹ STEP 1: Reading current Lambda environment variables..."
          aws lambda get-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} > /tmp/lambda-config.json
          
          CURRENT_VAR_COUNT=$(cat /tmp/lambda-config.json | jq -r '.Environment.Variables // {} | length')
          echo "   Found $CURRENT_VAR_COUNT existing variables in Lambda"
          
          if [ "$CURRENT_VAR_COUNT" -gt 0 ]; then
            echo "   Current Lambda variables:"
          cat /tmp/lambda-config.json | jq -r '.Environment.Variables // {} | keys[]' | while read key; do
              echo "      ðŸ—‘ï¸  $key (will be removed)"
          done
          fi
          
          # STEP 2: FORCE CLEAR ALL Lambda environment variables
          echo ""
          echo "ðŸ§¹ STEP 2: FORCE REMOVING ALL Lambda environment variables..."
          aws lambda update-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --environment '{"Variables":{}}' \
            --region ${{ env.AWS_REGION }} > /dev/null
          
          echo "â³ Waiting for Lambda to update after clearing..."
          aws lambda wait function-updated \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          # STEP 2.5: VERIFY variables are truly cleared
          echo ""
          echo "ðŸ” STEP 2.5: Verifying all variables were cleared..."
          aws lambda get-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} > /tmp/lambda-config-cleared.json
          
          CLEARED_VAR_COUNT=$(cat /tmp/lambda-config-cleared.json | jq -r '.Environment.Variables // {} | length')
          if [ "$CLEARED_VAR_COUNT" -eq 0 ]; then
            echo "âœ… All Lambda environment variables CLEARED (count: 0)"
          else
            echo "âŒ Failed to clear all variables! Still have $CLEARED_VAR_COUNT variables:"
            cat /tmp/lambda-config-cleared.json | jq -r '.Environment.Variables // {} | keys[]'
            exit 1
          fi

          # STEP 3: Build new environment variables from GitHub Secrets
          echo ""
          echo "ðŸ“¦ STEP 3: Building new environment variables from GitHub Secrets..."
          
          # Parse secrets and filter out GitHub internal secrets and AWS credentials
          echo "$SECRETS_JSON" | jq -r 'to_entries[] | select(
            .key | test("^GITHUB_") | not
          ) | select(
            .key | test("^AWS_ACCESS_KEY_ID$|^AWS_SECRET_ACCESS_KEY$") | not
          ) | {(.key): .value}' | jq -s 'add' > /tmp/lambda-env-vars.json
          
          NEW_VAR_COUNT=$(cat /tmp/lambda-env-vars.json | jq 'length')
          echo "   Prepared $NEW_VAR_COUNT variables from GitHub Secrets"
          echo ""
          echo "   Variables to upload:"
          cat /tmp/lambda-env-vars.json | jq -r 'keys[]' | sort | while read key; do
            echo "      âœ… $key"
          done
          
          # STEP 4: Upload ALL new variables to Lambda
          echo ""
          echo "ðŸš€ STEP 4: Uploading ALL GitHub Secrets to Lambda..."
          
          # Build final JSON structure
          echo "{\"Variables\":" > /tmp/lambda-env-final.json
          cat /tmp/lambda-env-vars.json >> /tmp/lambda-env-final.json
          echo "}" >> /tmp/lambda-env-final.json
          
          aws lambda update-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --environment file:///tmp/lambda-env-final.json \
            --region ${{ env.AWS_REGION }} > /dev/null
          
          echo "â³ Waiting for Lambda to update with new variables..."
          aws lambda wait function-updated \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          # STEP 5: Verify the sync
          echo ""
          echo "ðŸ” STEP 5: Verifying sync..."
          aws lambda get-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} > /tmp/lambda-config-after.json
          
          FINAL_VAR_COUNT=$(cat /tmp/lambda-config-after.json | jq -r '.Environment.Variables // {} | length')
          echo "   Lambda now has $FINAL_VAR_COUNT environment variables"
          
          if [ "$FINAL_VAR_COUNT" -eq "$NEW_VAR_COUNT" ]; then
            echo "âœ… Variable count matches! ($FINAL_VAR_COUNT = $NEW_VAR_COUNT)"
          else
            echo "âŒ Variable count mismatch! Expected $NEW_VAR_COUNT but got $FINAL_VAR_COUNT"
          fi
          
          echo ""
          echo "   Final Lambda variables:"
          cat /tmp/lambda-config-after.json | jq -r '.Environment.Variables // {} | keys[]' | sort | while read key; do
            echo "      âœ… $key"
          done
          
          # Cleanup
          rm -f /tmp/lambda-config.json /tmp/lambda-config-cleared.json /tmp/lambda-env-vars.json /tmp/lambda-env-final.json /tmp/lambda-config-after.json
          
          echo ""
          echo "âœ…âœ…âœ… SYNC COMPLETE âœ…âœ…âœ…"
          echo "âœ… Removed: $CURRENT_VAR_COUNT old variables"
          echo "âœ… Uploaded: $NEW_VAR_COUNT new variables from GitHub Secrets"
          echo "âœ… Final count: $FINAL_VAR_COUNT variables"
          echo "âœ… Lambda environment variables are now EXACTLY matched with GitHub Secrets"

      - name: Verify Lambda Function
        run: |
          echo "ðŸ” Verifying Lambda deployment..."
          
          # Get function configuration
          CONFIG=$(aws lambda get-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }})
          
          # Check runtime
          RUNTIME=$(echo $CONFIG | jq -r '.Runtime')
          if [[ "$RUNTIME" != "python3."* ]]; then
            echo "âŒ Unexpected runtime: $RUNTIME"
            exit 1
          fi
          
          # Check state
          STATE=$(echo $CONFIG | jq -r '.State')
          if [ "$STATE" != "Active" ]; then
            echo "âŒ Function state: $STATE (expected: Active)"
            exit 1
          fi
          
          echo "âœ… Lambda verification complete"
          echo "  Runtime: $RUNTIME"
          echo "  State: $STATE"

      - name: Update API Gateway CORS
        run: |
          echo "ðŸ”§ Updating API Gateway CORS configuration..."
          
          cd backend
          pip install -r requirements.txt
          
          python3 setup_aws.py api-cors
          
          echo "âœ… API Gateway CORS updated"

      - name: Update S3 CORS for Photo Uploads
        run: |
          echo "ðŸ”§ Configuring S3 CORS for photo uploads..."
          
          # Build CORS configuration dynamically with FRONTEND_URL
          cat > /tmp/s3-cors-config.json << EOF
          {
            "CORSRules": [
              {
                "AllowedOrigins": ["${{ secrets.FRONTEND_URL }}", "http://localhost:3000"],
                "AllowedMethods": ["GET", "HEAD", "POST", "PUT"],
                "AllowedHeaders": ["*"],
                "ExposeHeaders": ["ETag", "Content-Length", "Content-Type"],
                "MaxAgeSeconds": 3600
              }
            ]
          }
          EOF
          
          echo "ðŸ“„ CORS Configuration:"
          cat /tmp/s3-cors-config.json
          echo ""
          
          # Apply CORS to S3_PHOTOS_BUCKET (from GitHub Secrets)
          echo "ðŸ“„ Applying CORS to bucket: ${{ secrets.S3_PHOTOS_BUCKET }}..."
          aws s3api put-bucket-cors \
            --bucket "${{ secrets.S3_PHOTOS_BUCKET }}" \
            --cors-configuration file:///tmp/s3-cors-config.json \
            --region ${{ env.AWS_REGION }}
          
          # Verify configuration
          echo ""
          echo "ðŸ§ª Verifying CORS configuration..."
          aws s3api get-bucket-cors \
            --bucket "${{ secrets.S3_PHOTOS_BUCKET }}" \
            --region ${{ env.AWS_REGION }}
          
          # Cleanup
          rm -f /tmp/s3-cors-config.json
          
          echo ""
          echo "âœ… S3 CORS configured for bucket: ${{ secrets.S3_PHOTOS_BUCKET }}"

  # ========================================
  # STAGE 7: POST-DEPLOYMENT TESTS
  # ========================================
  test-deployment:
    name: âœ… Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Images Exist in S3 Bucket
        run: |
          echo "=========================================="
          echo "ðŸ“¸ VERIFYING IMAGES IN S3 BUCKET"
          echo "=========================================="
          echo ""
          echo "ðŸª£ Bucket: ${{ secrets.S3_PHOTOS_BUCKET }}"
          echo "ðŸ“‹ Listing first 20 images..."
          echo ""
          
          # Check if bucket has any images
          IMAGE_COUNT=$(aws s3 ls s3://${{ secrets.S3_PHOTOS_BUCKET }} --recursive | wc -l)
          
          if [ "$IMAGE_COUNT" -eq 0 ]; then
            echo "âš ï¸  WARNING: No images found in S3 bucket!"
            echo "   This might be expected for a fresh deployment"
            echo "   Upload some photos through the gallery interface"
          else
            echo "âœ… Found $IMAGE_COUNT images in bucket"
            echo ""
            echo "ðŸ“‹ Recent images (first 20):"
            aws s3 ls s3://${{ secrets.S3_PHOTOS_BUCKET }} --recursive --human-readable | head -20
          fi
          
          echo ""
          echo "=========================================="

      - name: Invalidate CDN CloudFront Cache
        run: |
          echo "=========================================="
          echo "ðŸ”„ INVALIDATING CDN CLOUDFRONT CACHE"
          echo "=========================================="
          echo ""
          echo "ðŸŒ Distribution ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "ðŸ“‹ Invalidating all cached images..."
          echo ""
          
          # Get CloudFront distribution ID for CDN (if different from main frontend distribution)
          # Try to find the CDN-specific distribution by comment
          CDN_DIST_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='Galerly Image CDN'].Id" \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$CDN_DIST_ID" ]; then
            echo "ðŸ“Œ Using main CloudFront distribution for cache invalidation"
            CDN_DIST_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          else
            echo "ðŸ“Œ Found dedicated CDN distribution: $CDN_DIST_ID"
          fi
          
          # Create cache invalidation
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "$CDN_DIST_ID" \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo ""
          echo "âœ… Cache invalidation created: $INVALIDATION_ID"
          echo "â³ CloudFront will serve fresh images (takes 1-2 minutes)"
          echo ""
          
          # Get invalidation status
          STATUS=$(aws cloudfront get-invalidation \
            --distribution-id "$CDN_DIST_ID" \
            --id "$INVALIDATION_ID" \
            --query 'Invalidation.Status' \
            --output text)
          
          echo "ðŸ“Š Invalidation Status: $STATUS"
          echo ""
          echo "=========================================="

      - name: Test Frontend Availability
        run: |
          echo "ðŸŒ Testing frontend availability..."
          
          # Test homepage
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.FRONTEND_URL }})
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Homepage accessible (HTTP $HTTP_CODE)"
          else
            echo "âŒ Homepage returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Test Lambda Function
        run: |
          echo "âš¡ Testing Lambda function..."
          
          # Invoke Lambda with inline JSON payload
          # AWS CLI v2 requires --cli-binary-format to accept raw JSON
          aws lambda invoke \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --cli-binary-format raw-in-base64-out \
            --payload '{"httpMethod":"GET","path":"/v1/health"}' \
            --region ${{ env.AWS_REGION }} \
            /tmp/lambda-response.json > /tmp/invoke-result.json
          
          # Check if invocation succeeded
          STATUS_CODE=$(cat /tmp/invoke-result.json | jq -r '.StatusCode')
          if [ "$STATUS_CODE" = "200" ]; then
            echo "âœ… Lambda function invoked successfully"
            echo "Response: $(cat /tmp/lambda-response.json)"
          else
            echo "âŒ Lambda invocation failed (Status: $STATUS_CODE)"
            echo "Response: $(cat /tmp/lambda-response.json)"
            exit 1
          fi

      - name: Verify CloudFront Distribution
        run: |
          echo "ðŸŒ Verifying CloudFront distribution..."
          
          STATUS=$(aws cloudfront get-distribution \
            --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --query 'Distribution.Status' \
            --output text)
          
          if [ "$STATUS" = "Deployed" ]; then
            echo "âœ… CloudFront distribution deployed"
          else
            echo "âš ï¸  CloudFront status: $STATUS"
          fi

      - name: Verify RAW Format Support in Lambda
        run: |
          echo "=========================================="
          echo "ðŸ“¸ Verifying Lambda Layer Configuration"
          echo "=========================================="
          echo ""
          
          # Get Lambda configuration
          aws lambda get-function-configuration \
            --function-name ${{ secrets.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} > /tmp/lambda-config.json
          
          # Check layers
          LAYER_COUNT=$(cat /tmp/lambda-config.json | jq -r '.Layers // [] | length')
          
          if [ "$LAYER_COUNT" -eq 0 ]; then
            echo "âŒ No layers attached to Lambda function!"
            echo "   RAW format support will NOT work!"
            exit 1
          fi
          
          echo "âœ… Lambda has $LAYER_COUNT layer(s) attached"
          echo ""
          echo "ðŸ“‹ Attached Layers:"
          cat /tmp/lambda-config.json | jq -r '.Layers[] | "   - \(.Arn)"'
          
          # Check if our image processing layer is attached
          if cat /tmp/lambda-config.json | jq -r '.Layers[].Arn' | grep -q "galerly-image-processing"; then
            echo ""
            echo "âœ… galerly-image-processing layer is attached!"
            echo "   ðŸ“¸ RAW format support: ENABLED (DNG, CR2, NEF, ARW, RAF, ORF, RW2, PEF, 3FR)"
            echo "   ðŸ“± HEIC support: ENABLED (HEIC, HEIF for iPhone)"
            echo "   ðŸ”¢ NumPy support: ENABLED"
            echo "   ðŸ–¼ï¸  Pillow: ENABLED"
          else
            echo ""
            echo "âŒ galerly-image-processing layer NOT found!"
            echo "   RAW format support will NOT work!"
            exit 1
          fi
          
          # Cleanup
          rm -f /tmp/lambda-config.json
          
          echo ""
          echo "=========================================="
          echo "âœ… Lambda Layer Verification Complete!"
          echo "=========================================="

  # ========================================
  # STAGE 8: DEPLOYMENT SUMMARY
  # ========================================
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, test-deployment]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "========================================" >> $GITHUB_STEP_SUMMARY
          echo "# ðŸŽ‰ Galerly Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "========================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (S3) | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Lambda) | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| CloudFront | âœ… Updated |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache | âœ… Invalidated |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Image Processing Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Feature | Status | Formats |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| RAW Format Support | âœ… Enabled | DNG, CR2, CR3, NEF, ARW, RAF, ORF, RW2, PEF, 3FR |" >> $GITHUB_STEP_SUMMARY
          echo "| HEIC Support | âœ… Enabled | HEIC, HEIF (iPhone) |" >> $GITHUB_STEP_SUMMARY
          echo "| Standard Formats | âœ… Enabled | JPEG, PNG, WEBP, GIF |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scanning | âœ… Enabled | Malware detection + metadata stripping |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Preservation | âœ… Enabled | Quality=98 (near-lossless) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Lambda Layer Architecture" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Layer: galerly-image-processing (~34MB)**" >> $GITHUB_STEP_SUMMARY
          echo "- Pillow (image manipulation)" >> $GITHUB_STEP_SUMMARY
          echo "- rawpy (RAW format support)" >> $GITHUB_STEP_SUMMARY
          echo "- pillow-heif (HEIC/HEIF support)" >> $GITHUB_STEP_SUMMARY
          echo "- numpy (required by rawpy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Main Function (~20MB)**" >> $GITHUB_STEP_SUMMARY
          echo "- Application code (handlers, utils, api.py)" >> $GITHUB_STEP_SUMMARY
          echo "- boto3 (AWS SDK)" >> $GITHUB_STEP_SUMMARY
          echo "- stripe (payment processing)" >> $GITHUB_STEP_SUMMARY
          echo "- python-dotenv" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Size: ~54MB (well under 250MB limit)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL**: ${{ secrets.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: ${{ secrets.S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lambda Function**: ${{ secrets.LAMBDA_FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront ID**: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Verify frontend at: ${{ secrets.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“¸ Test DNG/RAW file uploads" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ“± Test HEIC file uploads (iPhone photos)" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ“Š Monitor CloudWatch logs for Lambda errors" >> $GITHUB_STEP_SUMMARY
          echo "5. ðŸ§ª Test critical user flows" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "========================================" >> $GITHUB_STEP_SUMMARY
