name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  ANALYTICS_TABLE: ${{ vars.ANALYTICS_TABLE }}
  API_BASE_URL: ${{ vars.API_BASE_URL }}
  API_GATEWAY_ID: ${{ vars.API_GATEWAY_ID }}
  AUDIT_LOG_TABLE: ${{ vars.AUDIT_LOG_TABLE }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  BILLING_TABLE: ${{ vars.BILLING_TABLE }}
  CDN_DOMAIN: ${{ vars.CDN_DOMAIN }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}
  CLOUDFRONT_FUNCTION_NAME: ${{ vars.CLOUDFRONT_FUNCTION_NAME }}
  CNAME_TARGET: ${{ vars.CNAME_TARGET }}
  DEBUG: ${{ vars.DEBUG }}
  DEFAULT_INVOICE_CURRENCY: ${{ vars.DEFAULT_INVOICE_CURRENCY }}
  DEFAULT_INVOICE_DUE_DATE: ${{ vars.DEFAULT_INVOICE_DUE_DATE }}
  DEFAULT_INVOICE_PAYMENT_METHOD: ${{ vars.DEFAULT_INVOICE_PAYMENT_METHOD }}
  DEFAULT_ITEM_PRICE: ${{ vars.DEFAULT_ITEM_PRICE }}
  DEFAULT_ITEM_QUANTITY: ${{ vars.DEFAULT_ITEM_QUANTITY }}
  DEFAULT_PAGE_SIZE: ${{ vars.DEFAULT_PAGE_SIZE }}
  DEFAULT_PHOTOGRAPHER_NAME: ${{ vars.DEFAULT_PHOTOGRAPHER_NAME }}
  DEFAULT_SERVICE_NAME: ${{ vars.DEFAULT_SERVICE_NAME }}
  DYNAMODB_TABLE_ANALYTICS: ${{ vars.DYNAMODB_TABLE_ANALYTICS }}
  DYNAMODB_TABLE_APPOINTMENTS: ${{ vars.DYNAMODB_TABLE_APPOINTMENTS }}
  DYNAMODB_TABLE_AUDIT_LOG: ${{ vars.DYNAMODB_TABLE_AUDIT_LOG }}
  DYNAMODB_TABLE_BACKGROUND_JOBS: ${{ vars.DYNAMODB_TABLE_BACKGROUND_JOBS }}
  DYNAMODB_TABLE_BILLING: ${{ vars.DYNAMODB_TABLE_BILLING }}
  DYNAMODB_TABLE_CITIES: ${{ vars.DYNAMODB_TABLE_CITIES }}
  DYNAMODB_TABLE_CLIENT_FAVORITES: ${{ vars.DYNAMODB_TABLE_CLIENT_FAVORITES }}
  DYNAMODB_TABLE_CLIENT_FEEDBACK: ${{ vars.DYNAMODB_TABLE_CLIENT_FEEDBACK }}
  DYNAMODB_TABLE_CONTACT: ${{ vars.DYNAMODB_TABLE_CONTACT }}
  DYNAMODB_TABLE_CONTRACTS: ${{ vars.DYNAMODB_TABLE_CONTRACTS }}
  DYNAMODB_TABLE_CUSTOM_DOMAINS: ${{ vars.DYNAMODB_TABLE_CUSTOM_DOMAINS }}
  DYNAMODB_TABLE_DOWNLOADS: ${{ vars.DYNAMODB_TABLE_DOWNLOADS }}
  DYNAMODB_TABLE_EMAIL_TEMPLATES: ${{ vars.DYNAMODB_TABLE_EMAIL_TEMPLATES }}
  DYNAMODB_TABLE_FEATURES: ${{ vars.DYNAMODB_TABLE_FEATURES }}
  DYNAMODB_TABLE_FEATURE_REQUESTS: ${{ vars.DYNAMODB_TABLE_FEATURE_REQUESTS }}
  DYNAMODB_TABLE_FOLLOWUP_SEQUENCES: ${{ vars.DYNAMODB_TABLE_FOLLOWUP_SEQUENCES }}
  DYNAMODB_TABLE_GALLERIES: ${{ vars.DYNAMODB_TABLE_GALLERIES }}
  DYNAMODB_TABLE_INVOICES: ${{ vars.DYNAMODB_TABLE_INVOICES }}
  DYNAMODB_TABLE_LEADS: ${{ vars.DYNAMODB_TABLE_LEADS }}
  DYNAMODB_TABLE_NEWSLETTERS: ${{ vars.DYNAMODB_TABLE_NEWSLETTERS }}
  DYNAMODB_TABLE_NOTIFICATION_PREFERENCES: ${{ vars.DYNAMODB_TABLE_NOTIFICATION_PREFERENCES }}
  DYNAMODB_TABLE_ONBOARDING_WORKFLOWS: ${{ vars.DYNAMODB_TABLE_ONBOARDING_WORKFLOWS }}
  DYNAMODB_TABLE_PACKAGES: ${{ vars.DYNAMODB_TABLE_PACKAGES }}
  DYNAMODB_TABLE_PAYMENT_REMINDERS: ${{ vars.DYNAMODB_TABLE_PAYMENT_REMINDERS }}
  DYNAMODB_TABLE_PHOTOS: ${{ vars.DYNAMODB_TABLE_PHOTOS }}
  DYNAMODB_TABLE_PLAN_VIOLATIONS: ${{ vars.DYNAMODB_TABLE_PLAN_VIOLATIONS }}
  DYNAMODB_TABLE_RATE_LIMITS: ${{ vars.DYNAMODB_TABLE_RATE_LIMITS }}
  DYNAMODB_TABLE_RAW_VAULT: ${{ vars.DYNAMODB_TABLE_RAW_VAULT }}
  DYNAMODB_TABLE_REFUNDS: ${{ vars.DYNAMODB_TABLE_REFUNDS }}
  DYNAMODB_TABLE_SALES: ${{ vars.DYNAMODB_TABLE_SALES }}
  DYNAMODB_TABLE_SEO_SETTINGS: ${{ vars.DYNAMODB_TABLE_SEO_SETTINGS }}
  DYNAMODB_TABLE_SERVICES: ${{ vars.DYNAMODB_TABLE_SERVICES }}
  DYNAMODB_TABLE_SESSIONS: ${{ vars.DYNAMODB_TABLE_SESSIONS }}
  DYNAMODB_TABLE_SUBSCRIPTIONS: ${{ vars.DYNAMODB_TABLE_SUBSCRIPTIONS }}
  DYNAMODB_TABLE_TESTIMONIALS: ${{ vars.DYNAMODB_TABLE_TESTIMONIALS }}
  DYNAMODB_TABLE_USERS: ${{ vars.DYNAMODB_TABLE_USERS }}
  DYNAMODB_TABLE_USER_FEATURES: ${{ vars.DYNAMODB_TABLE_USER_FEATURES }}
  DYNAMODB_TABLE_VIDEO_ANALYTICS: ${{ vars.DYNAMODB_TABLE_VIDEO_ANALYTICS }}
  DYNAMODB_TABLE_VISITOR_TRACKING: ${{ vars.DYNAMODB_TABLE_VISITOR_TRACKING }}
  ENVIRONMENT: ${{ vars.ENVIRONMENT }}
  FROM_EMAIL: ${{ vars.FROM_EMAIL }}
  FROM_NAME: ${{ vars.FROM_NAME }}
  FRONTEND_URL: ${{ vars.FRONTEND_URL }}
  GALLERIES_TABLE: ${{ vars.GALLERIES_TABLE }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  LAMBDA_FUNCTION_NAME: ${{ vars.LAMBDA_FUNCTION_NAME }}
  LIFECYCLE_DELETED_RETENTION_DAYS: ${{ vars.LIFECYCLE_DELETED_RETENTION_DAYS }}
  LIFECYCLE_ORIGINAL_GLACIER_DAYS: ${{ vars.LIFECYCLE_ORIGINAL_GLACIER_DAYS }}
  LIFECYCLE_ORIGINAL_STANDARD_DAYS: ${{ vars.LIFECYCLE_ORIGINAL_STANDARD_DAYS }}
  LIFECYCLE_RENDITION_IA_DAYS: ${{ vars.LIFECYCLE_RENDITION_IA_DAYS }}
  LIFECYCLE_TEMP_EXPIRY_DAYS: ${{ vars.LIFECYCLE_TEMP_EXPIRY_DAYS }}
  MAX_USERNAME_BASE_LENGTH: ${{ vars.MAX_USERNAME_BASE_LENGTH }}
  MULTIPART_CHUNK_SIZE: ${{ vars.MULTIPART_CHUNK_SIZE }}
  PHOTOS_TABLE: ${{ vars.PHOTOS_TABLE }}
  PRESIGNED_URL_EXPIRY: ${{ vars.PRESIGNED_URL_EXPIRY }}
  REFUND_LIST_LIMIT: ${{ vars.REFUND_LIST_LIMIT }}
  S3_BUCKET: ${{ vars.S3_BUCKET }}
  S3_PHOTOS_BUCKET: ${{ vars.S3_PHOTOS_BUCKET }}
  S3_RENDITIONS_BUCKET: ${{ vars.S3_RENDITIONS_BUCKET }}
  SESSION_MAX_AGE: ${{ vars.SESSION_MAX_AGE }}
  SMTP_HOST: ${{ vars.SMTP_HOST }}
  SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
  SMTP_PORT: ${{ vars.SMTP_PORT }}
  SMTP_USER: ${{ vars.SMTP_USER }}
  STRIPE_PRICE_PLUS: ${{ vars.STRIPE_PRICE_PLUS }}
  STRIPE_PRICE_PLUS_ANNUAL: ${{ vars.STRIPE_PRICE_PLUS_ANNUAL }}
  STRIPE_PRICE_PLUS_MONTHLY: ${{ vars.STRIPE_PRICE_PLUS_MONTHLY }}
  STRIPE_PRICE_PRO: ${{ vars.STRIPE_PRICE_PRO }}
  STRIPE_PRICE_PRO_ANNUAL: ${{ vars.STRIPE_PRICE_PRO_ANNUAL }}
  STRIPE_PRICE_PRO_MONTHLY: ${{ vars.STRIPE_PRICE_PRO_MONTHLY }}
  STRIPE_PRICE_STARTER: ${{ vars.STRIPE_PRICE_STARTER }}
  STRIPE_PRICE_STARTER_ANNUAL: ${{ vars.STRIPE_PRICE_STARTER_ANNUAL }}
  STRIPE_PRICE_STARTER_MONTHLY: ${{ vars.STRIPE_PRICE_STARTER_MONTHLY }}
  STRIPE_PRICE_ULTIMATE: ${{ vars.STRIPE_PRICE_ULTIMATE }}
  STRIPE_PRICE_ULTIMATE_ANNUAL: ${{ vars.STRIPE_PRICE_ULTIMATE_ANNUAL }}
  STRIPE_PRICE_ULTIMATE_MONTHLY: ${{ vars.STRIPE_PRICE_ULTIMATE_MONTHLY }}
  STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
  SUBSCRIPTIONS_TABLE: ${{ vars.SUBSCRIPTIONS_TABLE }}
  SUPPORT_EMAIL: ${{ vars.SUPPORT_EMAIL }}
  USERS_TABLE: ${{ vars.USERS_TABLE }}
  VITE_API_TIMEOUT: ${{ vars.VITE_API_TIMEOUT }}
  VITE_BACKEND_HOST: ${{ vars.VITE_BACKEND_HOST }}
  VITE_BACKEND_PORT: ${{ vars.VITE_BACKEND_PORT }}
  VITE_BACKEND_PROTOCOL: ${{ vars.VITE_BACKEND_PROTOCOL }}
  VITE_CHUNK_SIZE: ${{ vars.VITE_CHUNK_SIZE }}
  VITE_DEFAULT_PAGE_SIZE: ${{ vars.VITE_DEFAULT_PAGE_SIZE }}
  VITE_DOUBLE_TAP_THRESHOLD: ${{ vars.VITE_DOUBLE_TAP_THRESHOLD }}
  VITE_ENABLE_ANALYTICS: ${{ vars.VITE_ENABLE_ANALYTICS }}
  VITE_ENABLE_ERROR_REPORTING: ${{ vars.VITE_ENABLE_ERROR_REPORTING }}
  VITE_ENVIRONMENT: ${{ vars.VITE_ENVIRONMENT }}
  VITE_IS_LOCALSTACK: ${{ vars.VITE_IS_LOCALSTACK }}
  VITE_MAX_CONCURRENT_UPLOADS: ${{ vars.VITE_MAX_CONCURRENT_UPLOADS }}
  VITE_MAX_PAGE_SIZE: ${{ vars.VITE_MAX_PAGE_SIZE }}
  VITE_PAGE_SIZE: ${{ vars.VITE_PAGE_SIZE }}
  VITE_S3_RENDITIONS_BUCKET: ${{ vars.VITE_S3_RENDITIONS_BUCKET }}
  VITE_SCROLL_DEBOUNCE_DELAY: ${{ vars.VITE_SCROLL_DEBOUNCE_DELAY }}
  VITE_SCROLL_THRESHOLD: ${{ vars.VITE_SCROLL_THRESHOLD }}
  VITE_SLIDESHOW_INTERVAL: ${{ vars.VITE_SLIDESHOW_INTERVAL }}
  VITE_UPLOAD_TIMEOUT: ${{ vars.VITE_UPLOAD_TIMEOUT }}
  VITE_VIDEO_AUTOPLAY_DELAY: ${{ vars.VITE_VIDEO_AUTOPLAY_DELAY }}
  VITE_VIDEO_PROGRESS_UPDATE_INTERVAL: ${{ vars.VITE_VIDEO_PROGRESS_UPDATE_INTERVAL }}
  WEBSITE_URL: ${{ vars.WEBSITE_URL }}

jobs:
  # STEP 1: BUILD
  build:
    runs-on: ubuntu-latest
    outputs:
      frontend-version: ${{ steps.frontend-build.outputs.version }}
      lambda-version: ${{ steps.lambda-package.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: user-app/frontend/package-lock.json
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install frontend dependencies
        working-directory: user-app/frontend
        run: npm ci
        
      - name: Build frontend
        id: frontend-build
        working-directory: user-app/frontend
        run: |
          npm run build
          echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
        
      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: user-app/frontend/dist
          retention-days: 7
          
      - name: Package Lambda function
        id: lambda-package
        working-directory: user-app/backend
        run: |
          pip install -r requirements.txt -t package/
          find package/ -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find package/ -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find package/ -name "*.pyc" -delete
          find package/ -name "*.pyo" -delete
          find package/ -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          cd package && zip -r9 ../deployment-${{ github.sha }}.zip . && cd ..
          zip -g deployment-${{ github.sha }}.zip *.py
          zip -rg deployment-${{ github.sha }}.zip handlers/ utils/
          ls -lh deployment-${{ github.sha }}.zip
          echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
          
      - name: Upload Lambda package artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package-${{ github.sha }}
          path: user-app/backend/deployment-${{ github.sha }}.zip
          retention-days: 7

  # STEP 2: UNIT TESTS
  unit-tests:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: user-app/frontend/package-lock.json
          
      - name: Install backend dependencies
        working-directory: user-app/backend
        run: pip install -r requirements.txt
        
      - name: Install frontend dependencies
        working-directory: user-app/frontend
        run: npm ci
        
      - name: Run backend unit tests
        working-directory: user-app/backend
        continue-on-error: true
        run: |
          pip install pytest pytest-cov moto boto3 flask
          pytest tests/ -v --junit-xml=test-results.xml
        
      - name: Run frontend unit tests
        working-directory: user-app/frontend
        run: npm test
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: user-app/backend/test-results.xml
          retention-days: 30

  # STEP 3: DEPLOY TO PRODUCTION
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build, unit-tests]
    if: github.ref == 'refs/heads/main'
    outputs:
      frontend-deployed: ${{ steps.deploy-frontend.outputs.deployed }}
      lambda-deployed: ${{ steps.deploy-lambda.outputs.deployed }}
      lambda-version: ${{ steps.deploy-lambda.outputs.version }}
      previous-lambda-version: ${{ steps.backup-lambda.outputs.previous-version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          
      # Backup current Lambda version before deployment (skip if function doesn't exist)
      - name: Backup current Lambda version
        id: backup-lambda
        run: |
          CURRENT_VERSION=$(aws lambda get-function --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} --query 'Configuration.Version' --output text 2>/dev/null || echo "none")
          echo "previous-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Backed up Lambda version: $CURRENT_VERSION"
          
      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: user-app/frontend/dist
          
      - name: Deploy frontend to S3
        id: deploy-frontend
        run: |
          aws s3 sync user-app/frontend/dist/ s3://${{ vars.S3_BUCKET }}/ --delete
          echo "deployed=true" >> $GITHUB_OUTPUT
          
      - name: Invalidate CloudFront cache
        continue-on-error: true
        run: |
          if [ "${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}" != "E1234567890ABC" ] && [ -n "${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            aws cloudfront create-invalidation \
              --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
              --paths "/*"
            echo "CloudFront cache invalidated"
          else
            echo "CloudFront distribution not configured yet, skipping invalidation"
          fi
          
      - name: Download Lambda package
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-${{ github.sha }}
          path: lambda-package
          
      - name: Deploy Lambda function
        id: deploy-lambda
        run: |
          # Create environment config JSON file
          cat > /tmp/lambda-env.json <<EOF
          {
            "Variables": {
              "AWS_REGION": "${{ vars.AWS_REGION }}",
              "DYNAMODB_TABLE_USERS": "${{ vars.DYNAMODB_TABLE_USERS }}",
              "DYNAMODB_TABLE_GALLERIES": "${{ vars.DYNAMODB_TABLE_GALLERIES }}",
              "DYNAMODB_TABLE_PHOTOS": "${{ vars.DYNAMODB_TABLE_PHOTOS }}",
              "DYNAMODB_TABLE_SUBSCRIPTIONS": "${{ vars.DYNAMODB_TABLE_SUBSCRIPTIONS }}",
              "DYNAMODB_TABLE_BILLING": "${{ vars.DYNAMODB_TABLE_BILLING }}",
              "DYNAMODB_TABLE_ANALYTICS": "${{ vars.DYNAMODB_TABLE_ANALYTICS }}",
              "S3_BUCKET": "${{ vars.S3_BUCKET }}",
              "S3_PHOTOS_BUCKET": "${{ vars.S3_PHOTOS_BUCKET }}",
              "S3_RENDITIONS_BUCKET": "${{ vars.S3_RENDITIONS_BUCKET }}",
              "FRONTEND_URL": "${{ vars.FRONTEND_URL }}",
              "API_BASE_URL": "${{ vars.API_BASE_URL }}",
              "STRIPE_PUBLISHABLE_KEY": "${{ secrets.STRIPE_PUBLISHABLE_KEY }}",
              "STRIPE_SECRET_KEY": "${{ secrets.STRIPE_SECRET_KEY }}",
              "STRIPE_WEBHOOK_SECRET": "${{ secrets.STRIPE_WEBHOOK_SECRET }}",
              "JWT_SECRET": "${{ secrets.JWT_SECRET }}",
              "SMTP_HOST": "${{ secrets.SMTP_HOST }}",
              "SMTP_PORT": "${{ secrets.SMTP_PORT }}",
              "SMTP_USER": "${{ secrets.SMTP_USER }}",
              "SMTP_PASSWORD": "${{ secrets.SMTP_PASSWORD }}",
              "FROM_EMAIL": "${{ vars.FROM_EMAIL }}",
              "FROM_NAME": "${{ vars.FROM_NAME }}"
            }
          }
          EOF
          
          # Check if Lambda function exists
          if aws lambda get-function --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} 2>/dev/null; then
            # Update existing function code
            aws lambda update-function-code \
              --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
              --zip-file fileb://lambda-package/deployment-${{ github.sha }}.zip \
              --publish
            
            # Update environment variables from JSON file
            aws lambda update-function-configuration \
              --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
              --environment file:///tmp/lambda-env.json
          else
            # Create new function with environment from JSON file
            aws lambda create-function \
              --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
              --runtime python3.11 \
              --role arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/galerly-lambda-execution-role \
              --handler api.handler \
              --zip-file fileb://lambda-package/deployment-${{ github.sha }}.zip \
              --timeout 30 \
              --memory-size 512 \
              --publish \
              --environment file:///tmp/lambda-env.json
          fi
          
          NEW_VERSION=$(aws lambda get-function --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} --query 'Configuration.Version' --output text)
          echo "deployed=true" >> $GITHUB_OUTPUT
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Deployed Lambda version: $NEW_VERSION"
          
      - name: Wait for Lambda deployment
        run: |
          echo "Waiting for Lambda function to be ready..."
          aws lambda wait function-updated --function-name ${{ vars.LAMBDA_FUNCTION_NAME }}

  # STEP 4: POST-DEPLOYMENT TESTS (Run in parallel)
  integration-tests:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        working-directory: user-app/backend
        run: |
          pip install requests pytest boto3
          
      - name: Run integration tests
        working-directory: user-app/backend
        env:
          TEST_API_URL: ${{ vars.API_BASE_URL }}
          TEST_FRONTEND_URL: ${{ vars.FRONTEND_URL }}
        run: |
          # Run integration tests against production
          pytest tests/ -v -m integration --junit-xml=integration-results.xml || exit 1
          
      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-results-${{ github.sha }}
          path: user-app/backend/integration-results.xml
          retention-days: 30

  verification-tests:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Verify Lambda function
        run: |
          aws lambda invoke \
            --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
            --payload '{"httpMethod":"GET","path":"/health"}' \
            response.json
          cat response.json
          
      - name: Verify S3 deployment
        run: |
          aws s3 ls s3://${{ vars.S3_BUCKET }}/index.html
          
      - name: Verify CloudFront distribution
        run: |
          STATUS=$(aws cloudfront get-distribution --id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} --query 'Distribution.Status' --output text)
          echo "CloudFront status: $STATUS"
          
      - name: Verify API Gateway
        run: |
          curl -f ${{ vars.API_BASE_URL }}/health || exit 1

  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Smoke test - Frontend accessible
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ vars.FRONTEND_URL }})
          if [ $HTTP_CODE -ne 200 ]; then
            echo "Frontend smoke test failed with HTTP $HTTP_CODE"
            exit 1
          fi
          
      - name: Smoke test - API health endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ vars.API_BASE_URL }}/health)
          if [ $HTTP_CODE -ne 200 ]; then
            echo "API health check failed with HTTP $HTTP_CODE"
            exit 1
          fi
          
      - name: Smoke test - Lambda function invocation
        run: |
          aws lambda invoke \
            --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
            --payload '{"httpMethod":"GET","path":"/api/v1/public/status"}' \
            lambda-response.json
          
          STATUS_CODE=$(jq -r '.statusCode' lambda-response.json)
          if [ "$STATUS_CODE" != "200" ]; then
            echo "Lambda smoke test failed with status $STATUS_CODE"
            cat lambda-response.json
            exit 1
          fi

  # STEP 5: ROLLBACK ON FAILURE
  rollback:
    runs-on: ubuntu-latest
    needs: [deploy-production, integration-tests, verification-tests, smoke-tests]
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      (needs.integration-tests.result == 'failure' || 
       needs.verification-tests.result == 'failure' || 
       needs.smoke-tests.result == 'failure')
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
          
      - name: Rollback Lambda to previous version
        run: |
          PREVIOUS_VERSION="${{ needs.deploy-production.outputs.previous-lambda-version }}"
          echo "Rolling back Lambda to version: $PREVIOUS_VERSION"
          
          aws lambda update-function-configuration \
            --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
            --publish
          
          aws lambda update-alias \
            --function-name ${{ vars.LAMBDA_FUNCTION_NAME }} \
            --name production \
            --function-version $PREVIOUS_VERSION || echo "Alias rollback not applicable"
          
      - name: Notify rollback
        run: |
          echo "Deployment rolled back due to test failures"
          echo "Previous Lambda version: ${{ needs.deploy-production.outputs.previous-lambda-version }}"
          echo "Failed deployment version: ${{ needs.deploy-production.outputs.lambda-version }}"
          
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Deployment Rollback - Build ${{ github.sha }}',
              body: `Deployment was automatically rolled back due to test failures.
              
              **Details:**
              - Commit: ${{ github.sha }}
              - Branch: ${{ github.ref_name }}
              - Previous Lambda Version: ${{ needs.deploy-production.outputs.previous-lambda-version }}
              - Failed Lambda Version: ${{ needs.deploy-production.outputs.lambda-version }}
              
              **Failed Tests:**
              - Integration Tests: ${{ needs.integration-tests.result }}
              - Verification Tests: ${{ needs.verification-tests.result }}
              - Smoke Tests: ${{ needs.smoke-tests.result }}
              
              [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
              labels: ['deployment', 'rollback', 'production']
            })
